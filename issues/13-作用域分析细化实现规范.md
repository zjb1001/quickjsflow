# ä½œç”¨åŸŸåˆ†æç»†åŒ–å®ç°è§„èŒƒ

## éœ€æ±‚
ç»†åŒ– Issue 04 çš„ä½œç”¨åŸŸåˆ†æè®¾è®¡ï¼Œæä¾›æ˜ç¡®çš„å®ç°è·¯çº¿ä¸éªŒæ”¶æ ‡å‡†ã€‚
ç¡®ä¿ä½œç”¨åŸŸç®¡ç†åœ¨å˜é‡é‡å‘½åã€ä»£ç ç¼–è¾‘ç­‰é«˜é˜¶æ“ä½œä¸­çš„æ­£ç¡®æ€§ã€‚

## æŠ€æœ¯è¦ç‚¹

### 1. ä½œç”¨åŸŸç±»å‹å®Œæ•´æ˜ å°„ä¸ä¼˜å…ˆçº§

| ä½œç”¨åŸŸç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ | é˜¶æ®µ | ä¼˜å…ˆçº§ |
|----------|------|------|------|-------|
| **Global** | å…¨å±€ä½œç”¨åŸŸï¼ˆç¨‹åºæ ¹ï¼‰ | `var x = 1` (é¡¶å±‚) | MVP | ğŸ”´ |
| **Module** | ESM æ¨¡å—é¡¶å±‚ä½œç”¨åŸŸ | import/export åœ¨æ­¤ä½œç”¨åŸŸ | MVP | ğŸ”´ |
| **Script** | Script æ¨¡å¼çš„é¡¶å±‚ | æµè§ˆå™¨ `<script>` | Phase 2 | ğŸŸ¡ |
| **Function** | å‡½æ•°çº§ä½œç”¨åŸŸ | `function f() {}` | MVP | ğŸ”´ |
| **Block** | å—çº§ä½œç”¨åŸŸ | if/while/for ä¸­çš„ let/const | MVP | ğŸ”´ |
| **Catch** | catch å—ä½œç”¨åŸŸ | `catch (e) {}` ä¸­çš„ e | MVP | ğŸ”´ |
| **Class** | ç±»çº§ä½œç”¨åŸŸ | class C {} ä¸­çš„æˆå‘˜ | Phase 2 | ğŸŸ¡ |
| **For** | for å¾ªç¯åˆå§‹åŒ–ä½œç”¨åŸŸ | `for (let i; ...)` çš„ i | MVP | ğŸ”´ |
| **For-in** | for-in å¾ªç¯åˆå§‹åŒ–ä½œç”¨åŸŸ | `for (let k in obj)` çš„ k | Phase 2 | ğŸŸ¡ |
| **Switch** | switch å—ä½œç”¨åŸŸ | switch ä¸­çš„ let/const | Phase 2 | ğŸŸ¡ |

**MVP ç›®æ ‡**ï¼šæ”¯æŒ Global, Module, Function, Block, Catch, For

---

### 2. å˜é‡ç±»å‹ä¸ç»‘å®š

#### å˜é‡å£°æ˜ç±»å‹

| å£°æ˜æ–¹å¼ | ä½œç”¨åŸŸ | æå‡ | TDZ | é‡å¤å£°æ˜ | ä¼˜å…ˆçº§ |
|---------|-------|------|-----|---------|-------|
| **var** | Function | âœ… (hoisted) | âŒ | âœ… (è¦†ç›–) | ğŸ”´ |
| **let** | Block | âŒ | âœ… | âŒ (é”™è¯¯) | ğŸ”´ |
| **const** | Block | âŒ | âœ… | âŒ (é”™è¯¯) | ğŸ”´ |
| **function å£°æ˜** | Function | âœ… (å…¨é‡) | âŒ | âœ… (è¦†ç›–) | ğŸ”´ |
| **class å£°æ˜** | Block | âŒ | âœ… | âŒ (é”™è¯¯) | ğŸŸ¡ |
| **import å£°æ˜** | Module | âœ… | âŒ | âŒ | ğŸ”´ |
| **å‚æ•°** | Function | âŒ | âŒ | âŒ | ğŸ”´ |

#### å˜é‡æå‡ï¼ˆHoistingï¼‰è§„åˆ™

```
// var æå‡ï¼šå£°æ˜æå‡ + åˆå€¼ undefined
console.log(x); // undefined
var x = 5;

// function å£°æ˜æå‡ï¼šæ•´ä¸ªå‡½æ•°å£°æ˜æå‡
foo(); // å¯ä»¥æ‰§è¡Œ
function foo() {}

// let/constï¼šä¸æå‡ï¼Œè¿›å…¥ TDZ
console.log(y); // ReferenceError
let y = 5;
```

**å®ç°**ï¼š
1. é¢„å¤„ç† ASTï¼Œæ”¶é›†æ‰€æœ‰ var å’Œ function å£°æ˜
2. åœ¨ä½œç”¨åŸŸåˆ›å»ºæ—¶æ·»åŠ  bindingï¼ˆå€¼ä¸º undefinedï¼‰
3. è¿½è¸ªå˜é‡èµ‹å€¼ï¼Œæ›´æ–° binding å€¼

---

### 3. æš‚æ—¶æ€§æ­»åŒºï¼ˆTDZï¼‰å¤„ç†

```javascript
// TDZ ç¤ºä¾‹
{
  console.log(x); // âŒ ReferenceError: Cannot access 'x' before initialization
  let x = 5;      // è¿™ä¸€è¡Œæ˜¯ TDZ çš„ç»ˆç‚¹
  console.log(x); // âœ… 5
}
```

**å®ç°æ–¹æ¡ˆ**ï¼š
- ä¸º let/const binding æ ‡è®° **TDZ èŒƒå›´**ï¼ˆfrom â†’ to çš„è¡Œåˆ—å·ï¼‰
- åœ¨ä½œç”¨åŸŸåˆ†ææ—¶ï¼Œæ£€æŸ¥ identifier å¼•ç”¨æ˜¯å¦åœ¨å…¶ binding çš„ TDZ å†…
- è‹¥æ˜¯ï¼Œæ ‡è®°ä¸º **TDZ violation**ï¼ˆä¾›é™æ€åˆ†ææˆ–è­¦å‘Šï¼‰

---

### 4. å¼•ç”¨è§£æä¸ç»‘å®šå»ºç«‹

#### å¼•ç”¨ç±»å‹

| å¼•ç”¨ç±»å‹ | ç¤ºä¾‹ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|---------|------|------|-------|
| **è¯»å¼•ç”¨** | `console.log(x)` | identifier åœ¨èµ‹å€¼å·¦ä¾§å¤– | ğŸ”´ |
| **å†™å¼•ç”¨** | `x = 5` | identifier åœ¨èµ‹å€¼å·¦ä¾§ | ğŸ”´ |
| **è¯»å†™æ··åˆ** | `x += 1` æˆ– `x++` | å…ˆè¯»åå†™ | ğŸ”´ |

**å®ç°**ï¼š
```javascript
// AST ä¸­çš„ AssignmentExpression
{
  type: 'AssignmentExpression',
  left: { type: 'Identifier', name: 'x' },  // å†™å¼•ç”¨
  right: { type: 'Identifier', name: 'y' }  // è¯»å¼•ç”¨
}
```

- éå† ASTï¼Œè¯†åˆ« identifier çš„ä¸Šä¸‹æ–‡ï¼ˆleft/rightï¼‰
- å»ºç«‹ Identifier node â†’ Binding çš„é“¾æ¥
- è®°å½•å¼•ç”¨ç±»å‹ï¼ˆread/writeï¼‰

---

### 5. å…¨å±€å˜é‡å¤„ç†

#### é¢„å®šä¹‰å…¨å±€å¯¹è±¡

éœ€è¦é¢„åŠ è½½çš„å…¨å±€å¯¹è±¡ï¼ˆMVP å¯é€‰ï¼ŒPhase 2 å¿…é¡»ï¼‰ï¼š
- æµè§ˆå™¨ï¼š`window`, `document`, `console`, `Array`, `Object`, ...
- Node.jsï¼š`global`, `require`, `module`, `console`, ...
- Universalï¼š`undefined`, `NaN`, `Infinity`, `parseInt`, `parseFloat`, ...

**å®ç°**ï¼š
- ç»´æŠ¤é¢„å®šä¹‰ binding åˆ—è¡¨ï¼ˆglobalThis å¯¹è±¡çš„å±æ€§ï¼‰
- Global ä½œç”¨åŸŸåˆ›å»ºæ—¶ï¼Œè‡ªåŠ¨æ·»åŠ è¿™äº› binding
- å¯é…ç½® environmentï¼ˆbrowser/node/universalï¼‰

#### éšå¼å…¨å±€å˜é‡

```javascript
x = 5; // æœªå£°æ˜çš„å˜é‡èµ‹å€¼ â†’ éšå¼å…¨å±€
```

**å¤„ç†**ï¼š
- æ ‡è®°ä¸º **implicit global** binding
- åœ¨åˆ†æä¸­æŠ¥å‘Šè­¦å‘Šæˆ–å¯è§†åŒ–æ ‡è®°

---

### 6. é®è”½æ£€æµ‹ï¼ˆShadowingï¼‰

```javascript
let x = 1;           // å¤–å±‚
{
  let x = 2;         // å†…å±‚é®è”½å¤–å±‚
  console.log(x);    // 2
}
console.log(x);      // 1
```

**å®ç°**ï¼š
1. ä¸ºæ¯ä¸ª binding è®°å½•å…¶**å£°æ˜ä½ç½®**ï¼ˆè¡Œåˆ—å·ï¼‰
2. åœ¨ä½œç”¨åŸŸé“¾ä¸Šæ£€æŸ¥æ˜¯å¦å­˜åœ¨åŒå binding
3. è‹¥å­˜åœ¨ï¼Œæ ‡è®°ä¸º **shadowed**
4. æä¾› API æŸ¥è¯¢è¢«é®è”½çš„ binding

---

### 7. ä½œç”¨åŸŸé“¾ï¼ˆScope Chainï¼‰éå†

**å®ç°**ï¼š
```javascript
interface Scope {
  type: 'global' | 'function' | 'block' | ...
  parent: Scope | null
  bindings: Map<string, Binding>
  
  // æŸ¥è¯¢æ–¹æ³•
  getBinding(name: string): Binding | null  // æœ¬ä½œç”¨åŸŸ
  resolveBinding(name: string): Binding | null  // ä½œç”¨åŸŸé“¾æŸ¥è¯¢
}
```

é€»è¾‘ï¼š
1. å½“å‰ä½œç”¨åŸŸæŸ¥æ‰¾ binding
2. è‹¥ä¸å­˜åœ¨ï¼Œå‘ä¸ŠæŸ¥è¯¢ parent
3. æœ€ç»ˆåˆ°è¾¾ globalï¼Œè¿”å› null æˆ– implicit global

---

## äº¤ä»˜ç‰©

### ğŸ“‹ è¯¦ç»†çš„å®ç°è§„èŒƒæ–‡æ¡£
- ä½œç”¨åŸŸç±»å‹å®Œæ•´è¡¨æ ¼
- å˜é‡æå‡è§„åˆ™è¯´æ˜ä¸ç¤ºä¾‹
- TDZ å¤„ç†æ–¹æ¡ˆ
- å¼•ç”¨è§£æç®—æ³•ä¼ªä»£ç 

### ğŸ§ª åˆ†ç±»å•æµ‹å¥—ä»¶
```
tests/scopes/
  â”œâ”€â”€ mvp/
  â”‚   â”œâ”€â”€ global_and_function.test.js      (Global, Function)
  â”‚   â”œâ”€â”€ block_scope.test.js              (Block)
  â”‚   â”œâ”€â”€ hoisting.test.js                 (var & function hoisting)
  â”‚   â”œâ”€â”€ tdz.test.js                      (TDZ æ£€æµ‹)
  â”‚   â”œâ”€â”€ variable_binding.test.js         (binding å»ºç«‹)
  â”‚   â”œâ”€â”€ reference_resolution.test.js     (å¼•ç”¨è§£æ)
  â”‚   â”œâ”€â”€ catch_scope.test.js              (Catch)
  â”‚   â””â”€â”€ for_loop_scope.test.js           (For)
  â”œâ”€â”€ phase2/
  â”‚   â”œâ”€â”€ class_scope.test.js
  â”‚   â”œâ”€â”€ switch_scope.test.js
  â”‚   â””â”€â”€ script_vs_module.test.js
  â””â”€â”€ advanced/
      â”œâ”€â”€ shadowing.test.js                (é®è”½æ£€æµ‹)
      â”œâ”€â”€ implicit_globals.test.js
      â””â”€â”€ predefined_globals.test.js       (å…¨å±€å¯¹è±¡)
```

**æ¯ä¸ªæ–‡ä»¶ 30-50 ä¸ªç”¨ä¾‹**ï¼Œè¦†ç›–ï¼š
- æ­£å¸¸æƒ…å†µ
- è¾¹ç•Œæƒ…å†µï¼ˆæ·±å±‚åµŒå¥—ã€é®è”½ã€TDZ è¾¹ç•Œç­‰ï¼‰
- é”™è¯¯æƒ…å†µï¼ˆé‡å¤å£°æ˜ç­‰ï¼‰

### ğŸ” ä½œç”¨åŸŸå¯è§†åŒ–/è°ƒè¯•å·¥å…·
- Scope dump å‡½æ•°ï¼ˆå¯¼å‡ºä½œç”¨åŸŸæ ‘ä¸ºå­—ç¬¦ä¸²/JSONï¼‰
- åœ¨çº¿å¯è§†åŒ–ï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰

### ğŸ“Š ä½œç”¨åŸŸåˆ†æå‡†ç¡®æ€§æŒ‡æ ‡
- binding å‡†ç¡®ç‡æµ‹è¯•
- å¼•ç”¨è§£æå‡†ç¡®ç‡æµ‹è¯•
- TDZ æ£€æµ‹å‡†ç¡®ç‡

---

## éªŒæ”¶æ ‡å‡†

- âœ… èƒ½æ­£ç¡®å¤„ç† MVP çš„æ‰€æœ‰ä½œç”¨åŸŸç±»å‹ï¼ˆGlobal, Module, Function, Block, Catch, Forï¼‰
- âœ… å˜é‡æå‡ï¼ˆvar & function declarationï¼‰æµ‹è¯•å…¨é€šè¿‡
- âœ… TDZ æ£€æµ‹å‡†ç¡®ï¼ˆåŒ…æ‹¬åµŒå¥—ã€å¤æ‚åœºæ™¯ï¼‰
- âœ… å¼•ç”¨èƒ½æ­£ç¡®æŒ‡å‘å…¶ bindingï¼Œè€ƒè™‘é®è”½æƒ…å†µ
- âœ… åŒºåˆ†è¯»/å†™å¼•ç”¨
- âœ… éšå¼å…¨å±€å˜é‡è¯†åˆ«
- âœ… å¯è§†åŒ–/Dump å·¥å…·å¯ç”¨
- âœ… é›†æˆ Issue 11 çš„ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆä½œç”¨åŸŸæ›´æ–°åï¼Œç¼–è¾‘+é‡è§£æçš„ç¨³å®šæ€§ï¼‰

---

## ä¼˜å…ˆçº§

ğŸ”´ **MVP**ï¼ˆç»†åŒ– Issue 04ï¼Œå¿…é¡»åœ¨å®ç°å‰å®Œæˆï¼‰

---

## ä¾èµ–
- Issue 03: Parserï¼ˆéœ€æä¾›å®Œæ•´çš„ ASTï¼‰
- Issue 04: ScopeManagerï¼ˆæœ¬ Issue æ˜¯å…¶ç»†åŒ–è§„èŒƒï¼‰

---

## å®æ–½æŒ‡å—

### é˜¶æ®µ 1ï¼šè®¾è®¡ä¸æ¥å£å®šä¹‰
- å®šä¹‰ Scope, Binding, Reference çš„æ•°æ®ç»“æ„
- å®ç°ä½œç”¨åŸŸé“¾æŸ¥è¯¢æ¥å£

### é˜¶æ®µ 2ï¼šæ ¸å¿ƒå®ç°ï¼ˆMVPï¼‰
- Global + Module ä½œç”¨åŸŸ
- Function å’Œ Block ä½œç”¨åŸŸ
- å˜é‡æå‡ä¸ TDZ

### é˜¶æ®µ 3ï¼šéªŒæ”¶ä¸æ–‡æ¡£
- å•æµ‹é€šè¿‡ï¼ˆ>90% è¦†ç›–ç‡ï¼‰
- å¯è§†åŒ–å·¥å…·å°±ç»ª
- é›†æˆ Issue 11 æµ‹è¯•

