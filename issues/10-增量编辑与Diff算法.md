# 增量编辑与 Diff 算法

## 需求
支持增量编辑场景：给定旧 AST 和新源文本，高效重解析受影响的部分，
保留未修改部分的 AST 节点引用（便于文档编辑器等场景）。

这对于：
- 长文件编辑性能优化
- 编辑器实时反馈
- 保持编辑历史中的节点引用稳定性

## 📁 项目结构与开发环境

参考根目录 [issues/00-完整Issue清单与执行计划.md](00-完整Issue清单与执行计划.md) 的**项目结构**与**构建与测试命令**章节。关键路径：
- 源码：`src/diff.c`, `include/quickjsflow/diff.h`（待实现，Phase 2）
- 测试：`test/test_incremental.c`（待实现）
- 构建：`make && make test`
- 当前状态：MVP 版本使用全量重解析，Phase 2 后考虑增量优化
- 性能目标：行级编辑不触发全文重解析

## 优先级
🟡 **Phase 2**（MVP 后优化）


## 技术要点

### 文本 Diff 与变更定位
- **Myers diff 或 Patience diff**：计算源文本与新文本的最小变更集
- **变更范围扩展**：在词法/语法边界处扩展（如完整行、完整表达式）
- **context 缓冲**：重解析时前后各保留一定的语境行数

### 增量重解析策略
- **Range-based reparsing**：仅重新 lex + parse 变更范围
- **增量作用域更新**：仅更新影响范围内的作用域链
- **节点复用**：变更外的 AST 节点保持引用不变

### 位置映射维护
- **旧→新位置映射表**：编辑后的 AST 节点位置更新
- **增量位置调整**：行列号偏移计算

## 交付物
- Incremental Parser 模块（StreamingLexer + RangeParser）
- Diff 引擎（Myers diff 实现）
- 增量更新策略单测（50+ 场景）
- 性能对标（1000 行文件单行编辑延迟）

## 验收标准
- ✅ 行级编辑不触发全文重解析
- ✅ AST 节点引用稳定性测试通过（节点恒等性）
- ✅ 位置映射正确性测试（10+ 复杂场景）
- ✅ 增量更新延迟基线测试

## 优先级
🟡 **Phase 2**（MVP 可用全量重解析，此优化为后续性能提升）

## 依赖
- Issue 02 (Lexer 错误恢复)
- Issue 03 (Parser AST 结构)
- Issue 04 (ScopeManager)

