# 集成测试与模块边界规范

## 需求
定义各模块间的 API 契约，确保端到端流程（parse → scope → edit → codegen）
的正确性，建立集成测试框架。各模块的输入/输出接口必须明确版本化，
支持模块的独立迭代而不破坏下游。

## 技术要点

### 模块间接口规范

#### 1. Lexer → Parser: Token 流接口
```
接口：TokenStream
- next(): Token | EOF
- peek(): Token | EOF
- Token 类型枚举（keyword, identifier, string, number, operator, ...）
- 版本号标记
```

#### 2. Parser → ScopeManager: AST 结构
```
接口：ASTNode（所有节点的基类）
- type: string (符合 ESTree spec)
- loc: SourceLocation
- parent: ASTNode | null
- comments: Comment[]（Leading, Trailing, Inner）
```

#### 3. ScopeManager → Edit API: Scope 查询接口
```
接口：ScopeInfo
- getScopeAt(node: ASTNode): Scope
- getVariableBinding(identifier: string, scope: Scope): Binding | null
- getScopeChain(scope: Scope): Scope[]
```

#### 4. Edit API → Codegen: AST 不可变性约定
```
不可变性保证：
- 所有编辑操作返回新的 AST 副本
- 原 AST 保持不变
- 新 AST 节点的 id 与内容相对应
```

### 端到端流程验证（Round-trip Testing）
```
源码 → Lexer → Token流
           ↓
        Parser → AST
           ↓
    ScopeManager → 作用域信息
           ↓
      Edit API → 修改后 AST
           ↓
       Codegen → 目标源码
           ↓
    再次 Lexer+Parser → 新 AST
           ↓
    对比：新 AST ≈ 修改后 AST（结构等价）
```

验证标准：
- AST 结构一致（递归比较节点）
- 注释保留完整
- 位置信息连续

### 集成测试框架设计
- **分层测试**：
  - 单模块单测（各 issue 内实施）
  - 双模块集成测试（Lexer+Parser, Parser+Scope, ...）
  - 全链路端到端测试（500+ 用例）

- **快照与回归**：
  - 建立标准用例库（baseline.json）
  - 支持快照比对与自动更新
  - 回归用例库版本管理

- **模块 Mock/Stub**：
  - 提供测试用 Lexer/Parser/Codegen
  - 支持错误注入测试

## 交付物
- 📋 接口定义文档（TypeScript `.d.ts` 或 markdown）
- 🧪 集成测试脚本（Jest 配置 + 核心用例）
- 📊 快照/基线文件（500+ 用例）
- 🔧 模块 Mock 工具类
- 📈 集成测试覆盖率报告

## 验收标准
- ✅ 各模块独立通过单测 + 集成测试全绿（CI 通过）
- ✅ Round-trip 测试 500+ 用例全通过（包含错误恢复场景）
- ✅ 快照稳定性（baseline 变更可追踪）
- ✅ 接口文档完整（每个公共接口有说明）
- ✅ 模块间版本兼容性声明

## 优先级
🔴 **MVP**（必须在各模块实现前明确，避免重返工作）

## 依赖
- 所有其他 Issue 的设计（02-07）

## 实施时机
- **设计评审阶段**：定义接口契约
- **开发并行**：各模块按契约实现单测
- **集成期**：补充集成测试与快照

