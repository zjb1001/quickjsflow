# 产品愿景与范围基线

## 背景
明确 JS 引擎（解析+编辑）的目标受众、使用场景和非目标。

## 范围
- **支持的 ECMAScript 版本**：分阶段实现（详见 Issue 12：ESTree AST 语法完整性矩阵）
  - **MVP**：ES2020 基础特性 + 主要控制流结构
  - **Phase 2**：ES2021-2022 现代特性（箭头函数、解构、async/await 等）
  - **Phase 3+**：可选性实验特性

- **编辑能力**：提供不可变的原子操作 API（详见 Issue 05）
  - Insert / Replace / Remove / Move / Rename
  - 所有操作返回新 AST，保持原树不变

- **关键特性**：
  - 注释与格式保留（Trivia Preservation）
  - 完整的静态作用域分析（Scope Analysis）
  - 错误恢复与 Partial AST 构建
  - 增量编辑支持（Phase 2）

## Issue 元数据
- 类型：Epic / 产品基线
- 标签：product, scope, mvp
- 负责人：@page
- 目标版本：v0.1.0（MVP）
- 依赖：Issue 12（语法矩阵）、Issue 13（作用域规范）

## 错误处理策略

### 容错目标
目标是在面临多种源文本异常时，仍能输出**最大可用的 AST**，支持持续编辑。

### 容错级别
| 级别 | 说明 | 示例 | 交付 AST |
|------|------|------|----------|
| **L1** | 词法错误不阻止 | 未闭合字符串、无效转义 | Token 流 + 错误标记 |
| **L2** | 语法错误输出部分 AST | 缺少 ) 或语法混乱 | Partial AST + Error 节点 |
| **L3** | 作用域缺陷非致命 | 变量未定义、重复声明 | 完整 AST + 警告/标记 |

### 实现细节
- **Lexer**（Issue 02）：识别错误 token，继续扫描
- **Parser**（Issue 03）：用 Error 节点表示无法解析的子树，尝试同步恢复
- **ScopeManager**（Issue 04/13）：允许分析缺陷但不中断分析过程

## 动机与使用场景
- 大型项目的增量编辑与自动化重构（安全重命名、语句插入/移动）
- 代码质量工具链（lint/format/transform）与 IDE 集成
- 解析-编辑-生成的稳定 Round-trip 能力，服务于插件生态

## 目标 / 非目标
- 目标：构建可维护、可扩展、可测试的 JS 解析与编辑引擎（ESTree 兼容）
- 非目标：运行时执行引擎、JIT/解释器、语言服务的完整实现

## 假设与约束
- 以 ESTree 为 AST 兼容标准；位置与注释为一等公民
- 以不可变编辑为核心设计，避免共享引用带来的副作用
- 容错优先于严格拒绝：确保编辑中的连续性

## 风险与缓解
- 风险：阶段语法覆盖不一致 → 缓解：Issue 12 作为单一真源（SoT）
- 风险：作用域边界复杂 → 缓解：Issue 13 提供细化规范与用例
- 风险：性能退化 → 缓解：Issue 09 建立基准与报警阈值

## 编辑原子操作集

| 操作 | 签名 | 说明 | 是否需要作用域感知 |
|------|------|------|------------------|
| **Insert** | `insert(parentNode, index, newNode): AST` | 在父节点的子节点列表中插入 | ❌ |
| **Replace** | `replace(oldNode, newNode): AST` | 替换指定节点 | ✅ (检查捕获) |
| **Remove** | `remove(node): AST` | 删除指定节点及其子树 | ✅ (未使用检查) |
| **Move** | `move(node, newParent, index): AST` | 移动节点到新位置 | ✅ (检查遮蔽) |
| **Rename** | `rename(identifier, newName): AST` | 重命名标识符及其所有引用 | ✅ (必须) |

## MVP 与延后范围

### ✅ MVP 范围
- Lexer + Parser（阶段 1 语法）
- 基础 ScopeManager（Global, Function, Block, Catch, For 作用域）
- 不可变编辑 API（Insert/Replace/Remove/Move）
- Codegen + SourceMap
- 错误恢复（容错 L1 + 部分 L2）
- 集成测试框架
- CLI 基础命令

### ⏸️ 延后范围（Phase 2+）
- 阶段 2 语法支持
- 变量重命名高级特性
- 增量编辑与 Diff 优化
- 高级作用域（Class, Switch）
- 数据流分析（CFG 高级特性）
- 插件系统完整化

## 交付物
- 📄 README：产品说明、快速开始
- 📋 ADR（Architecture Decision Record）：关键设计决策
- 📊 Issue 清单与优先级规划
- 🗺️ 整体架构图
- 📝 风险与依赖清单

## 验收标准
- ✅ 文档清晰阐述 MVP 目标与延后范围
- ✅ 错误处理策略明确，各容错级别有示例
- ✅ 编辑原子操作集完整定义
- ✅ 相关 Issue 清单链接完整（Issue 12/13 等）
- ✅ 风险/依赖/时间表可追踪
- ✅ 项目成员对范围达成共识

## 任务清单（可用于 GitHub 子任务）
- [ ] 完成语法矩阵（Issue 12）并标记阶段覆盖
- [ ] 完成作用域规范（Issue 13）含 TDZ/提升/遮蔽
- [ ] 明确错误容错级别与示例（L1/L2/L3）
- [ ] 定义编辑原子操作签名与约束（Issue 05 参考）
- [ ] 输出 ADR（解析策略、注释挂载、不可变编辑）
- [ ] 更新 README/架构图/风险清单

## Definition of Done
- 文档合并到主分支并被引用于 00 Epic 与相关 Issue
- 所有依赖 Issue（12/13）状态为“明确可实施”
- 团队评审通过，范围与目标一致
