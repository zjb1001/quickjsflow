# è¯­æ³•è§£æä¸ ESTree AST ç»“æ„

## éœ€æ±‚
å®ç°ä¸€ä¸ªé€’å½’ä¸‹é™è§£æå™¨ï¼ˆRecursive Descent Parserï¼‰ï¼Œå°† Token æµè½¬æ¢ä¸ºç¬¦åˆ ESTree æ ‡å‡†çš„ ASTã€‚
è§£æå™¨å¿…é¡»å…·å¤‡ **L2 çº§å®¹é”™èƒ½åŠ›**ï¼ˆè¯­æ³•é”™è¯¯ä¸ä¸­æ–­ï¼Œè¾“å‡º Partial ASTï¼‰ï¼Œå¹¶å®ç°**ç²¾å‡†çš„æ³¨é‡ŠæŒ‚è½½**ã€‚

## Issue å…ƒæ•°æ®
- ç±»å‹ï¼šFeatureï¼ˆæ ¸å¿ƒç®¡çº¿ï¼‰
- æ ‡ç­¾ï¼šparser, ast, estree, mvp
- è´Ÿè´£äººï¼š@page
- ä¾èµ–ï¼šIssue 02ï¼ˆLexerï¼‰ã€Issue 12ï¼ˆè¯­æ³•çŸ©é˜µï¼‰
- ç›®æ ‡ç‰ˆæœ¬ï¼šv0.1.0ï¼ˆMVPï¼‰

## ğŸ“ é¡¹ç›®ç»“æ„ä¸å¼€å‘ç¯å¢ƒ

å‚è€ƒæ ¹ç›®å½• [issues/00-å®Œæ•´Issueæ¸…å•ä¸æ‰§è¡Œè®¡åˆ’.md](00-å®Œæ•´Issueæ¸…å•ä¸æ‰§è¡Œè®¡åˆ’.md) çš„**é¡¹ç›®ç»“æ„**ä¸**æ„å»ºä¸æµ‹è¯•å‘½ä»¤**ç« èŠ‚ã€‚å…³é”®è·¯å¾„ï¼š
- æºç ï¼š`src/parser.c`, `include/quickjsflow/parser.h`, `src/ast_print.c`, `include/quickjsflow/ast.h`
- æµ‹è¯•ï¼š`test/test_integration.c`, `test/test_roundtrip.c`
- ç¤ºä¾‹ï¼š`examples/` ç›®å½•å«å„ç§ JS æ ·æœ¬
- æ„å»ºï¼š`make` ç¼–è¯‘ï¼Œ`make test` è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
- å‘½ä»¤ï¼š`./build/quickjsflow parse <file>` æŸ¥çœ‹ AST JSON è¾“å‡º

## æŠ€æœ¯è¦ç‚¹

### 1. è§£ææ¶æ„
- **è¾“å…¥**ï¼šTokenStream (from Issue 02)
- **è¾“å‡º**ï¼šESTree Program Node
- **ç®—æ³•**ï¼šé€’å½’ä¸‹é™ï¼ˆRecursive Descentï¼‰
  - æ¯ä¸ªè¯­æ³•è§„åˆ™å¯¹åº”ä¸€ä¸ªè§£æå‡½æ•°ï¼ˆe.g., `parseStatement`, `parseExpression`ï¼‰
  - åˆ©ç”¨ `lookahead` (peek) å†³å®šåˆ†æ”¯

### 2. é”™è¯¯æ¢å¤ç­–ç•¥ï¼ˆL2 å®¹é”™ï¼‰
ç›®æ ‡ï¼šé‡åˆ°è¯­æ³•é”™è¯¯æ—¶ï¼Œä¸æŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢ï¼Œè€Œæ˜¯æ¢å¤åˆ°åŒæ­¥ç‚¹ç»§ç»­è§£æã€‚
- **åŒæ­¥ç‚¹ï¼ˆSynchronization Pointsï¼‰**ï¼šé€šå¸¸æ˜¯è¯­å¥ç»“æŸç¬¦ `;` æˆ–å—ç»“æŸç¬¦ `}`ã€‚
- **Error Node**ï¼šåœ¨ AST ä¸­æ’å…¥è‡ªå®šä¹‰çš„ `ErrorNode` æˆ–ä¿ç•™éƒ¨åˆ†ç»“æ„ï¼Œæ ‡è®° `error: true`ã€‚
- **ç­–ç•¥**ï¼š
  - é‡åˆ°æ„å¤– Tokenï¼šæŠ¥é”™ -> ä¸¢å¼ƒ Token ç›´åˆ°é‡åˆ°åŒæ­¥ç‚¹ -> æ¢å¤è§£æä¸‹ä¸€æ¡è¯­å¥ã€‚
  - ç¼ºå¤± Tokenï¼ˆå¦‚åˆ†å·ï¼‰ï¼šæŠ¥é”™ -> è‡ªåŠ¨è¡¥å…¨ï¼ˆé€»è¾‘ä¸Šï¼‰-> ç»§ç»­ã€‚

### 3. æ³¨é‡ŠæŒ‚è½½ï¼ˆComment Attachmentï¼‰
æ³¨é‡Šä¸æ˜¯æ ‡å‡† ESTree çš„ä¸€éƒ¨åˆ†ï¼Œä½†å¯¹ç¼–è¾‘è‡³å…³é‡è¦ã€‚
- **å­˜å‚¨**ï¼šåœ¨ AST èŠ‚ç‚¹ä¸Šçš„ `leadingComments` (å‰ç½®), `trailingComments` (åç½®), `innerComments` (å†…éƒ¨) å±æ€§ã€‚
- **ç®—æ³•**ï¼š
  - ç»´æŠ¤ä¸€ä¸ªå¾…å¤„ç†æ³¨é‡Šåˆ—è¡¨ã€‚
  - èŠ‚ç‚¹è§£æå¼€å§‹å‰ï¼Œæ”¶é›†ä¹‹å‰çš„æ³¨é‡Šä½œä¸º `leading`ã€‚
  - èŠ‚ç‚¹è§£æç»“æŸåï¼Œæ”¶é›†ç´§éšå…¶åçš„æ³¨é‡Šä½œä¸º `trailing`ã€‚
  - å¯¹äº BlockStatement æˆ– ObjectExpressionï¼Œå¤„ç†å¤§æ‹¬å·å†…çš„ `inner` æ³¨é‡Šã€‚

### 4. ä¼˜å…ˆçº§ä¸ç»“åˆæ€§ï¼ˆPratt Parsing æˆ– ä¼˜å…ˆçº§è¡¨ï¼‰
- å¤„ç†äºŒå…ƒè¡¨è¾¾å¼ï¼ˆ`+`, `*`, `&&`ï¼‰çš„ä¼˜å…ˆçº§ã€‚
- å»ºè®®ä½¿ç”¨ **Pratt Parsing** (Top-Down Operator Precedence) å¤„ç†è¡¨è¾¾å¼ï¼Œç®€åŒ–é€’å½’é€»è¾‘ã€‚

## äº¤ä»˜ç‰©
- ğŸ”§ Parser æ ¸å¿ƒæ¨¡å—
  - `parse(source: string, options?: ParserOptions): Program`
- ğŸ“š AST ç±»å‹å®šä¹‰ï¼ˆæ‰©å±• ESTree ä»¥æ”¯æŒ ErrorNodeï¼‰
- ğŸ§ª æµ‹è¯•å¥—ä»¶
  - **Snapshot Tests**ï¼šé’ˆå¯¹ Issue 12 ä¸­çš„æ‰€æœ‰ MVP è¯­æ³•ã€‚
  - **Error Recovery Tests**ï¼šè¾“å…¥é”™è¯¯ä»£ç ï¼ŒéªŒè¯ AST ç»“æ„å’Œé”™è¯¯ä¿¡æ¯ã€‚
  - **Comment Tests**ï¼šéªŒè¯æ³¨é‡Šæ˜¯å¦æŒ‚è½½åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ã€‚

## ä»»åŠ¡æ¸…å•
- [x] å®šä¹‰ AST èŠ‚ç‚¹ç±»å‹ï¼ˆTypeScript æ¥å£æˆ– JSDocï¼‰ï¼ŒåŒ…å« `loc`, `range`, `comments`ã€‚
- [x] å®ç°åŸºç¡€è§£ææ¡†æ¶ï¼ˆ`Parser` ç±»ï¼Œ`next()`, `expect()` ç­‰å·¥å…·æ–¹æ³•ï¼‰ã€‚
- [x] å®ç° **Statement** è§£æï¼ˆVariable, If, Return, Block, etc.ï¼‰ã€‚
- [x] å®ç° **Expression** è§£æï¼ˆBinary, Unary, Call, Member, etc.ï¼‰ã€‚
- [x] å®ç° **Pratt Parsing** å¤„ç†è¡¨è¾¾å¼ä¼˜å…ˆçº§ã€‚
- [x] å®ç° **L2 é”™è¯¯æ¢å¤**æœºåˆ¶ï¼ˆ`synchronize()` æ–¹æ³•ï¼‰ã€‚
- [x] å®ç° **æ³¨é‡ŠæŒ‚è½½** é€»è¾‘ã€‚
- [x] é›†æˆ Issue 12 çš„æ‰€æœ‰ MVP è¯­æ³•ç‰¹æ€§ã€‚
- [x] ç¼–å†™å¿«ç…§æµ‹è¯•ä¸å®¹é”™æµ‹è¯•ã€‚

## éªŒæ”¶æ ‡å‡†
- âœ… 100% è¦†ç›– Issue 12 å®šä¹‰çš„ MVP è¯­æ³•ã€‚
- âœ… è¯­æ³•é”™è¯¯æ—¶ï¼ŒParser ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯è¿”å›åŒ…å«é”™è¯¯ä¿¡æ¯çš„ ASTã€‚
- âœ… æ³¨é‡Šï¼ˆå•è¡Œ/å¤šè¡Œï¼‰å‡†ç¡®æŒ‚è½½ï¼Œä¸ä¸¢å¤±ï¼Œä¸æ¼‚ç§»ã€‚
- âœ… ä½ç½®ä¿¡æ¯ï¼ˆLine/Columnï¼‰ç²¾ç¡®ï¼ŒåŒ…å«èµ·å§‹å’Œç»“æŸã€‚
- âœ… é€šè¿‡ Test262 åŸºç¡€æµ‹è¯•é›†ï¼ˆå¯é€‰ï¼Œä½œä¸ºé«˜è´¨é‡æ ‡å‡†ï¼‰ã€‚

## å®ç°çŠ¶æ€
âœ… **å·²å®Œæˆ** (2025-12-27)
- å®ç°ï¼šsrc/parser.c (916è¡Œ), src/ast_print.c (1293è¡Œ)
- æµ‹è¯•ï¼š109ä¸ªæµ‹è¯•é€šè¿‡ (expressions 33, statements 19, phase1 24, roundtrip 23, integration 10)

## ä¼˜å…ˆçº§
ğŸ”´ **MVP**ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰

## ç›¸å…³ Issue
- Issue 02: Lexerï¼ˆä¸Šæ¸¸ï¼‰
- Issue 04: ScopeManagerï¼ˆä¸‹æ¸¸ï¼‰
- Issue 12: è¯­æ³•çŸ©é˜µï¼ˆè§„èŒƒï¼‰
